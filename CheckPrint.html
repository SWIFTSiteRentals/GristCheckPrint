<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Check Print Preview</title>
  <style>
    /* ===== CUSTOM FONTS ===== */
    @font-face {
      font-family: 'Norwester';
      src: url('Norwester.woff2') format('woff2');
    }

    @font-face {
      font-family: 'Open Sans';
      src: url('OpenSans-Regular.woff2') format('woff2');
    }

    @font-face {
      font-family: 'Lacquer';
      src: url('Lacquer-Regular.woff2') format('woff2');
    }

    @font-face {
      font-family: 'MICR';
      src: url('MICREncoding.woff2') format('woff2');
    }

    /* ===== PAGE SETUP ===== */
    @page {
      size: 8.5in 11in;
      margin: 0;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Open Sans', Arial, sans-serif;
      font-size: 10.5px;
      overflow: hidden;          /* <-- stop scrolling inside the widget */
    }

    .page {
      width: 8.5in;
      height: 4.5in;             /* <-- only tall enough for check + button */
      position: relative;
      box-sizing: border-box;
    }

    /* ===== CHECK AREA (EXACT 3.50") ===== */
    .check-area {
      width: 100%;
      height: 3.50in;
      padding: 0.18in 0.25in 0.10in;
      box-sizing: border-box;
      position: relative;
    }

    /* ===== VOID WATERMARK ===== */
    .void-watermark {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-10deg);
      font-family: 'Norwester', Arial, sans-serif;
      font-size: 270px;
      letter-spacing: 0.12em;
      color: dimgrey;
      opacity: 0.40;
      pointer-events: none;
      display: none;
      z-index: 1;
      white-space: nowrap;
      text-transform: uppercase;

    }

    /* ===== TOP HEADER ===== */
    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      position: relative;
      z-index: 2;
    }

    .account-block {
      max-width: 55%;
      line-height: 1.15;
      /* instead of margin-top, move it visually with transform
         so the rest of the layout does NOT get pushed down */
      transform: translateY(0.08in);
    }

    .account-name {
      font-family: 'Norwester', 'Open Sans', Arial, sans-serif;
      font-size: 12px;
      letter-spacing: 0.03em;
    }

    .date-block {
      font-size: 14px;
      position: absolute;
      top: 0.05in;
      right: 1.49in;
      text-align: center;
      width: 0.75in;
    }

    .date-value {
      display: inline-block;
      margin-bottom: 0.02in;
    }

    .date-underline {
      border-bottom: 1px solid #000;
      width: 100%;
      margin: 0 auto;
      height: 0.02in;
    }

    .date-label {
      font-size: 9px;
      letter-spacing: 0.03em;
      margin-top: 0.01in;
      text-align: right;
    }

    .date-line {
      display: inline-block;
      min-width: 0.5in;
      border-bottom: 1px solid #000;
      margin-left: 0.10in;
    }

    .check-number-block {
      font-size: 16px;
      font-weight: bold;
      margin-top: 0.05in;
    }

    /* ===== PAYEE ROW ===== */
    .payee-row {
      margin-top: 0.18in;
      display: flex;
      align-items: center;
      gap: 0.10in;
      position: relative;
      z-index: 2;
      font-size: 8px;
    }

    .payee-label {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 0.5in;
    }

    .payee-label-inner {
      text-align: center;
      line-height: 1.1;
      white-space: nowrap;
    }

    .payee-line {
      border-bottom: 1px solid #000;
      border-right: 1px solid #000;
      flex: 1;
      padding-bottom: 0.03in;
      font-size: 16px;
      font-family: 'Lacquer', 'Open Sans', Arial, sans-serif;
      padding-right: 0.03in;

      /* pull the line left under "PAY TO THE ORDER OF" */
      margin-left: -0.60in;
      padding-left: 0.60in;
      text-transform: lowercase;
    }

    .amount-block-inline {
      display: flex;
      align-items: center;
      gap: 0.05in;
      white-space: nowrap;
    }

    .amount-dollar {
      font-size: 16px;
      line-height: 1;
      margin-top: -0.02in;
    }

    .amount-box {
      border: 2px solid #000;
      padding: 0.06in 0.10in;
      min-width: 1.0in;
      text-align: right;
      font-size: 11px;
    }

    /* ===== AMOUNT IN WORDS ===== */
    .amount-words-row {
      margin-top: 0.15in;
      display: flex;
      align-items: baseline;
      gap: 0.08in;
      position: relative;
      z-index: 2;
    }

    .amount-words-line {
      flex: 1;
      border-bottom: 1px solid #000;
      padding-bottom: 0.03in;
      display: flex;
      align-items: flex-end;
      position: relative;
      min-height: 0.16in;
    }

    .amount-words-text {
      font-family: 'Lacquer', 'Open Sans', Arial, sans-serif;
      font-size: 12px;
      white-space: nowrap;
      padding-right: 0.06in;
      z-index: 1;
      text-transform: lowercase;
    }

    .amount-words-filler {
      flex: 1;
      height: 0.14in;
      display: block;
    }

    .amount-words-filler svg {
      width: 100%;
      height: 100%;
      overflow: visible;
    }

    .amount-words-dollars {
      font-size: 11px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    /* ===== BANK LOGO ROW ===== */
    .bank-row {
      margin-top: 0.18in;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      position: relative;
      z-index: 2;
      height: 0.75in;
    }

    .bank-logo-block {
      display: flex;
      flex-direction: column;
      gap: 0.05in;
    }

    :root {
      --logo-scale: 0.8;
    }

    .bank-logo {
      width: calc(2.4in * var(--logo-scale));
      height: 0.65in;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      transform: translateX(0.175in);
      font-size: calc(9px * var(--logo-scale));
      text-align: center;
      overflow: hidden;
      position: relative;
    }

    .bank-logo img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .bank-logo.has-logo #bank-logo-text {
      display: none;
    }

    /* ===== MEMO + SIGNATURE AREA ===== */
    .bottom-row {
      margin-top: 0.22in;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      font-size: 10px;
      position: relative;
      z-index: 2;
    }

    .memo-wrapper {
      display: flex;
      flex-direction: column;
      width: 3.0in;
    }

    .memo-line {
      position: relative;
      border-bottom: 1px solid #000;
      width: 100%;
      height: 0.18in;
    }

    #field-memo {
      position: absolute;
      left: 0;
      bottom: 0.02in;
      font-size: 12px;
      font-family: 'Lacquer', 'Open Sans', Arial, sans-serif;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      right: 0;
      text-transform: lowercase;
    }

    .memo-label {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-top: 0.01in;
      width: 100%;
      text-align: right;
    }

    .signature-container {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .signature-line {
      border-bottom: 1px solid #000;
      width: 3.5in;
      height: 0.18in;
      margin-left: 0.25in;
    }

    /* ===== MICR BAND & GRID (ACTUAL MICR LINE) ===== */
    .micr-debug-band {
      position: absolute;
      bottom: 0;
      left: 0.25in;
      right: 0.25in;
      height: 0.625in;   /* ANSI clear band height */
      box-sizing: border-box;
      z-index: 1;
      border: none;
      background: transparent;
    }

    .micr-debug-grid {
      position: absolute;
      bottom: 0.19in;     /* baseline about 3/16" up */
      left: 0;
      right: 0;
      height: 0.25in;
      display: grid;
      grid-template-columns: repeat(62, 0.125in);
      border-top: none;
      border-bottom: none;
    }

    .micr-debug-cell {
      border-left: none;
      border-right: none;
      font-family: 'MICR';
      font-size: 0.30in;     /* adjust to match your reference checks */
      line-height: 0.25in;
      text-align: right;
      position: relative;
    }

    .micr-debug-cell:last-child {
      border-right: none;
    }

    .micr-debug-char {
      display: inline-block;
      width: 100%;
    }

    .micr-debug-index {
      display: none;         /* hide box numbers both screen & print */
    }

    /* ===== PRINT BUTTON ===== */
    .print-button {
      position: absolute;
      top: 3.0in;            /* ~0.5" below 3.5" check area */
      right: 0.25in;
      padding: 0.08in 0.25in;
      font-size: 11px;
      border-radius: 4px;
      border: 1px solid #444;
      background: #eee;
      cursor: pointer;
      z-index: 10;
    }

    .print-button:hover {
      background: #ddd;
    }

    @media print {
      .print-button {
        display: none;
      }
    }
  </style>

  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
</head>
<body>
  <div class="page">
    <button class="print-button" onclick="window.print()">Print</button>

    <div class="check-area">
      <!-- VOID WATERMARK -->
      <div class="void-watermark" id="void-watermark">VOID</div>

      <!-- TOP HEADER -->
      <div class="top-row">
        <div class="account-block">
          <div class="account-name" id="field-accountname">{{AccountHolderName}}</div>
          <div id="field-addr1">{{StreetAddressLine1}}</div>
          <div id="field-addr2">{{StreetAddressLine2}}</div>
          <div id="field-citystatezip">{{City}}, {{State}} {{Zip}}</div>
        </div>

        <div class="date-block">
          <span class="date-value" id="field-checkdate">{{CheckDate}}</span>
          <div class="date-underline"></div>
          <div class="date-label">DATE</div>
        </div>

        <div class="check-number-block" id="field-checknum">
          {{CheckNumber}}
        </div>
      </div>

      <!-- PAYEE ROW -->
      <div class="payee-row">
        <div class="payee-label">
          <div class="payee-label-inner">
            PAY TO THE<br>ORDER OF
          </div>
        </div>
        <div class="payee-line" id="field-payto">{{PayTo}}</div>
        <div class="amount-block-inline">
          <span class="amount-dollar">$</span>
          <div class="amount-box" id="field-amount">{{Amount}}</div>
        </div>
      </div>

      <!-- AMOUNT IN WORDS -->
      <div class="amount-words-row">
        <div class="amount-words-line">
          <span class="amount-words-text" id="field-amountwords">{{AmountInWords}}</span>
          <span class="amount-words-filler">
            <svg viewBox="0 0 100 10" preserveAspectRatio="none">
              <path d="M0,7 Q 50,1 100,7"
                    fill="none"
                    stroke="#000"
                    stroke-width="1.2"
                    stroke-linecap="round" />
            </svg>
          </span>
        </div>
        <div class="amount-words-dollars">DOLLARS</div>
      </div>

      <!-- BANK LOGO -->
      <div class="bank-row">
        <div class="bank-logo-block">
          <div class="bank-logo" id="field-banklogo">
            <img id="bank-logo-img" alt="Bank logo" />
            <span id="bank-logo-text">{{BankName}} LOGO</span>
          </div>
        </div>
      </div>

      <!-- MEMO + SIGNATURE -->
      <div class="bottom-row">
        <div class="memo-wrapper">
          <div class="memo-line">
            <span id="field-memo"></span>
          </div>
          <div class="memo-label">MEMO</div>
        </div>

        <div class="signature-container">
          <div class="signature-line"></div>
        </div>
      </div>

      <!-- MICR BAND / GRID (VISUAL GRID HIDDEN, MICR CHARS SHOWN) -->
      <div class="micr-debug-band">
        <div class="micr-debug-grid" id="micr-debug-grid"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== DATE FORMATTING: M/D/YY, AVOIDING TIMEZONE SLIP =====
    function formatShortDate(raw) {
      if (raw == null || raw === '') return '';

      // If string like "2025-01-15" or "2025-01-15T..." â€“ take the leading date part
      if (typeof raw === 'string') {
        var m = raw.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (m) {
          var month = parseInt(m[2], 10);
          var day   = parseInt(m[3], 10);
          var yy    = m[1].slice(-2);
          return month + '/' + day + '/' + yy;
        }
      }

      // If it's already a Date object, use UTC so it doesn't slide by timezone
      if (raw instanceof Date) {
        var y  = raw.getUTCFullYear();
        var mo = raw.getUTCMonth() + 1;
        var d  = raw.getUTCDate();
        var yy = String(y).slice(-2);
        return mo + '/' + d + '/' + yy;
      }

      // Fallback: try to parse, still using UTC components
      var dObj = new Date(raw);
      if (!isNaN(dObj)) {
        var y2  = dObj.getUTCFullYear();
        var m2  = dObj.getUTCMonth() + 1;
        var d2  = dObj.getUTCDate();
        var yy2 = String(y2).slice(-2);
        return m2 + '/' + d2 + '/' + yy2;
      }

      return String(raw);
    }

    /* ===== BASIC HELPERS ===== */
    function setText(id, value) {
      var el = document.getElementById(id);
      if (!el) return;
      if (value == null || value === undefined) {
        el.textContent = '';
      } else {
        el.textContent = String(value);
      }
    }

    function formatAmount(value) {
      if (value == null || value === '') return '';
      var num = Number(value);
      if (isNaN(num)) return String(value);
      return num.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    function numberToWordsUnder1000(n) {
      var ones = [
        '', 'One', 'Two', 'Three', 'Four', 'Five', 'Six',
        'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve',
        'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen',
        'Seventeen', 'Eighteen', 'Nineteen'
      ];
      var tens = [
        '', '', 'Twenty', 'Thirty', 'Forty', 'Fifty',
        'Sixty', 'Seventy', 'Eighty', 'Ninety'
      ];

      var result = '';

      if (n >= 100) {
        result += ones[Math.floor(n / 100)] + ' Hundred';
        n = n % 100;
        if (n > 0) result += ' ';
      }
      if (n >= 20) {
        result += tens[Math.floor(n / 10)];
        n = n % 10;
        if (n > 0) result += '-' + ones[n];
      } else if (n > 0) {
        result += ones[n];
      }

      return result || 'Zero';
    }

    function numberToWordsDollars(n) {
      if (n === 0) return 'Zero';
      if (!Number.isFinite(n) || n < 0) return String(n);

      var parts = [];

      var billions = Math.floor(n / 1000000000);
      if (billions) {
        parts.push(numberToWordsUnder1000(billions) + ' Billion');
        n = n % 1000000000;
      }

      var millions = Math.floor(n / 1000000);
      if (millions) {
        parts.push(numberToWordsUnder1000(millions) + ' Million');
        n = n % 1000000;
      }

      var thousands = Math.floor(n / 1000);
      if (thousands) {
        parts.push(numberToWordsUnder1000(thousands) + ' Thousand');
        n = n % 1000;
      }

      if (n) {
        parts.push(numberToWordsUnder1000(n));
      }

      return parts.join(' ');
    }

    function formatAmountInWords(value) {
      if (value == null || value === '') return '';
      var num = Number(value);
      if (isNaN(num)) return String(value);

      var centsTotal = Math.round(num * 100);
      var dollars   = Math.floor(centsTotal / 100);
      var cents     = centsTotal % 100;

      var words = numberToWordsDollars(dollars);
      var centsStr = String(cents).padStart(2, '0');

      return words + ' & ' + centsStr + '/100';
    }

    /* ===== MICR GRID CREATION + UPDATE ===== */
    var TOTAL_MICR_BOXES = 62;  // positions 62..01

    function initMicrGrid() {
      var grid = document.getElementById('micr-debug-grid');
      if (!grid) return;

      grid.innerHTML = '';

      // positions 62..01 left to right
      for (var pos = TOTAL_MICR_BOXES; pos >= 1; pos--) {
        var cell = document.createElement('div');
        cell.className = 'micr-debug-cell';

        var charSpan = document.createElement('span');
        charSpan.className = 'micr-debug-char';
        charSpan.textContent = '';

        var idx = document.createElement('div');
        idx.className = 'micr-debug-index';
        idx.textContent = (pos < 10 ? '0' + pos : String(pos));

        cell.appendChild(charSpan);
        cell.appendChild(idx);
        grid.appendChild(cell);
      }
    }

    // boxChars is an array indexed 1..62 with characters ('' for blank)
    function updateMicrGrid(boxChars) {
      var grid = document.getElementById('micr-debug-grid');
      if (!grid) return;
      if (!boxChars) boxChars = [];

      var cells = grid.children;
      // cells[0] = box 62, cells[61] = box 01
      for (var pos = TOTAL_MICR_BOXES; pos >= 1; pos--) {
        var cellIndex = TOTAL_MICR_BOXES - pos;  // 62->0, 61->1, ..., 1->61
        var cell = cells[cellIndex];
        if (!cell) continue;
        var span = cell.querySelector('.micr-debug-char');
        if (!span) continue;
        span.textContent = boxChars[pos] || '';
      }
    }

    /* ===== GRIST INTEGRATION ===== */
    var bankByAccountName = null;

    async function ensureBankCache() {
      if (bankByAccountName) return;

      bankByAccountName = {};

      try {
        if (!window.grist || !grist.docApi) {
          return;
        }

        var table = await grist.docApi.fetchTable('CheckAccountData');
        var cols = table;
        var ids = cols.id;
        if (!ids) return;

        for (var i = 0; i < ids.length; i++) {
          var row = {
            id: ids[i],
            Account_Name: cols.Account_Name ? cols.Account_Name[i] : null,
            Account_Holder_Name: cols.Account_Holder_Name ? cols.Account_Holder_Name[i] : null,
            Street_Address_Line_1: cols.Street_Address_Line_1 ? cols.Street_Address_Line_1[i] : null,
            Street_Address_Line_2: cols.Street_Address_Line_2 ? cols.Street_Address_Line_2[i] : null,
            City: cols.City ? cols.City[i] : null,
            State: cols.State ? cols.State[i] : null,
            Zip: cols.Zip ? cols.Zip[i] : null,
            Bank_Name: cols.Bank_Name ? cols.Bank_Name[i] : null,
            Bank_Logo: cols.Bank_Logo ? cols.Bank_Logo[i] : null,
            Logo_URL: cols.Logo_URL ? cols.Logo_URL[i] : null,
            Routing_Number: cols.Routing_Number ? cols.Routing_Number[i] : null,
            Account_Number: cols.Account_Number ? cols.Account_Number[i] : null
          };

          var acct = row.Account_Name;
          if (acct) {
            bankByAccountName[acct.toString().trim()] = row;
          }
        }
      } catch (e) {
        console.error('Error loading CheckAccountData table:', e);
        bankByAccountName = {};
      }
    }

    function buildCityStateZip(row) {
      var city = row.City || '';
      var state = row.State || '';
      var zip = row.Zip || '';
      var parts = [];
      if (city) parts.push(city);
      if (state) parts.push(state);
      var line = parts.join(', ');
      if (zip) line = line ? (line + ' ' + zip) : zip;
      return line;
    }

    function resolveBankRow(bankCell) {
      if (!bankCell || !bankByAccountName) return null;
      var key = bankCell.toString().trim();
      return bankByAccountName[key] || null;
    }

    // Build MICR box mapping from routing/account/check numbers
    function buildMicrBoxes(routing, account, checkNumber) {
      var boxes = new Array(TOTAL_MICR_BOXES + 1).fill('');

      // digits only
      routing = (routing || '').toString().replace(/\D/g, '');
      account = (account || '').toString().replace(/\D/g, '');
      checkNumber = (checkNumber || '').toString().replace(/\D/g, '');

      // routing: max 9 digits
      routing = routing.slice(0, 9);

      // check: last 4 digits, zero-padded
      checkNumber = checkNumber.slice(-4);
      checkNumber = checkNumber.padStart(4, '0');

      var TRANSIT = 'A'; // |:
      var ONUS   = 'C'; // ||*

      // Box 62: leading transit
      boxes[62] = TRANSIT;

      // Boxes 61..53: routing digits (left-to-right)
      for (var i = 0; i < routing.length && i < 9; i++) {
        var boxPos = 61 - i; // 61,60,...,53
        if (boxPos >= 53) {
          boxes[boxPos] = routing[i];
        }
      }

      // Box 52: trailing transit
      boxes[52] = TRANSIT;

      // Boxes 51..49: blanks

      // Box 48: account start symbol
      boxes[48] = ONUS;

      // Boxes 47 downward: account digits
      var pos = 47;
      for (var j = 0; j < account.length && pos >= 1; j++) {
        boxes[pos] = account[j];
        pos--;
      }

      // Trailing ONUS if room
      if (pos >= 1) {
        boxes[pos] = ONUS;
        pos--;
      }

      // 3 blank boxes
      pos -= 3;
      if (pos < 1) pos = 1;

      // Check number: 4 boxes starting at current pos downward
      for (var k = 0; k < checkNumber.length && pos >= 1; k++) {
        boxes[pos] = checkNumber[k];
        pos--;
      }

      return boxes;
    }

    async function updateFromRecord(record) {
      if (!record) return;
      console.log('Selected row:', record);

      setText('field-payto', record.Pay_To);
      setText('field-amount', formatAmount(record.Amount));
      setText('field-checknum', record.Check_Number);
      setText('field-checkdate', formatShortDate(record.Check_Date));
      setText('field-memo', record.Memo);
      setText('field-amountwords', formatAmountInWords(record.Amount));

      // VOID watermark
      var status = (record.Status || '').toString().toLowerCase();
      var voidEl = document.getElementById('void-watermark');
      if (voidEl) {
        voidEl.style.display = status.startsWith('void') ? 'block' : 'none';
      }

      // Clear header
      setText('field-accountname', '');
      setText('field-addr1', '');
      var addr2El = document.getElementById('field-addr2');
      if (addr2El) {
        addr2El.style.display = 'none';
        addr2El.textContent = '';
      }
      setText('field-citystatezip', '');

      var logoWrapper = document.getElementById('field-banklogo');
      var logoImg = document.getElementById('bank-logo-img');
      var logoText = document.getElementById('bank-logo-text');
      if (logoWrapper && logoImg && logoText) {
        logoWrapper.classList.remove('has-logo');
        logoImg.src = '';
        logoImg.style.display = 'none';
        logoText.textContent = '{{BankName}} LOGO';
      }

      // Default: clear MICR boxes
      updateMicrGrid(null);

      // No bank? stop here
      if (record.Bank == null || record.Bank === '') {
        return;
      }

      await ensureBankCache();
      var bankRow = resolveBankRow(record.Bank);
      console.log('Resolved bankRow:', bankRow);

      if (!bankRow) {
        return;
      }

      // Account / address
      var acctName = bankRow.Account_Holder_Name || bankRow.Account_Name || '';
      setText('field-accountname', acctName);
      setText('field-addr1', bankRow.Street_Address_Line_1 || '');

      if (addr2El) {
        var addr2Val = bankRow.Street_Address_Line_2 || '';
        if (addr2Val) {
          addr2El.style.display = '';
          addr2El.textContent = addr2Val;
        } else {
          addr2El.style.display = 'none';
          addr2El.textContent = '';
        }
      }

      setText('field-citystatezip', buildCityStateZip(bankRow));

      // Bank name text / logo placeholder
      var bankName = bankRow.Bank_Name || '';
      if (logoText) {
        logoText.textContent = bankName ? (bankName + ' LOGO') : 'BANK LOGO';
      }

      // Bank logo via URL column (Logo_URL)
      if (logoWrapper && logoImg) {
        var logoUrl = (bankRow.Logo_URL || '').toString().trim();
        if (logoUrl) {
          logoImg.src = logoUrl;
          logoImg.style.display = 'block';
          logoWrapper.classList.add('has-logo');
        } else {
          logoImg.src = '';
          logoImg.style.display = 'none';
          logoWrapper.classList.remove('has-logo');
        }
      }

      // Build MICR box mapping using routing/account/check
      var routing = bankRow.Routing_Number;
      var account = bankRow.Account_Number;
      var chk     = record.Check_Number;

      var boxChars = buildMicrBoxes(routing, account, chk);
      updateMicrGrid(boxChars);
    }

    /* ===== STARTUP ===== */
    document.addEventListener('DOMContentLoaded', function () {
      initMicrGrid();          // build empty 62-box grid

      if (window.grist && typeof grist.ready === 'function') {
        grist.ready();
        if (typeof grist.onRecord === 'function') {
          grist.onRecord(function (record) {
            updateFromRecord(record);
          });
        }
      }
    });
  </script>
</body>
</html>
