<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Check Print Preview</title>
  <style>
    /* ===== CUSTOM FONTS ===== */
    @font-face {
      font-family: 'Norwester';
      src: url('Norwester.woff2') format('woff2');
    }

    @font-face {
      font-family: 'Open Sans';
      src: url('OpenSans-Regular.woff2') format('woff2');
    }

    @font-face {
      font-family: 'Lacquer';
      src: url('Lacquer-Regular.woff2') format('woff2');
    }

    @font-face {
      font-family: 'MICR';
      src: url('MICREncoding.woff2') format('woff2');
    }

    /* ===== PAGE SETUP ===== */
    @page {
      size: 8.5in 11in;
      margin: 0;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Open Sans', Arial, sans-serif;
      font-size: 10.5px;
    }

    .page {
      width: 8.5in;
      height: 11in;
      position: relative;
      box-sizing: border-box;
    }

    /* ===== CHECK AREA (EXACT 3.50") ===== */
    .check-area {
      width: 100%;
      height: 3.50in;
      padding: 0.18in 0.25in 0.10in;
      box-sizing: border-box;
      position: relative;
    }

    /* ===== VOID WATERMARK ===== */
    .void-watermark {
    position: absolute;
    top: 55%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-30deg);
    font-family: 'Norwester', Arial, sans-serif;
    font-size: 210px;      /* larger, spans almost full width */
    letter-spacing: 0.12em;
    color: red;
    opacity: 0.12;         /* slightly lighter so it doesnâ€™t overpower text */
    pointer-events: none;
    display: none;
    z-index: 1;
    white-space: nowrap;
  }


    /* ===== TOP HEADER ===== */
    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      position: relative;
      z-index: 2;
    }

    .account-block {
      max-width: 55%;
      line-height: 1.15;
    }

    .account-name {
      font-family: 'Norwester', 'Open Sans', Arial, sans-serif;
      font-size: 12px;
      letter-spacing: 0.03em;
    }

    .date-block {
      font-size: 10px;
      margin-top: 0.05in;
    }

    .date-line {
      display: inline-block;
      min-width: 1.1in;
      border-bottom: 1px solid #000;
      margin-left: 0.10in;
    }

    .check-number-block {
      font-size: 12px;
      font-weight: bold;
      margin-top: 0.05in;
    }

    /* ===== PAYEE ROW ===== */
    .payee-row {
      margin-top: 0.18in;
      display: flex;
      align-items: baseline;
      gap: 0.10in;
      position: relative;
      z-index: 2;
    }

    .payee-label {
      white-space: nowrap;
    }

    .payee-line {
      border-bottom: 1px solid #000;
      flex: 1;
      padding-bottom: 0.03in;
    }

    .amount-block-inline {
      display: flex;
      align-items: center;
      gap: 0.05in;
      white-space: nowrap;
    }

    .amount-box {
      border: 1px solid #000;
      padding: 0.04in 0.10in;
      min-width: 1.0in;
      text-align: right;
      font-size: 11px;
    }

    /* ===== AMOUNT IN WORDS ===== */
    .amount-words-row {
      margin-top: 0.15in;
      display: flex;
      align-items: baseline;
      gap: 0.08in;
      position: relative;
      z-index: 2;
    }

    .amount-words-line {
      border-bottom: 1px solid #000;
      flex: 1;
      padding-bottom: 0.03in;
    }

    .amount-words-text {
      font-family: 'Lacquer', 'Open Sans', Arial, sans-serif;
      font-size: 11px;
    }

    /* ===== BANK LOGO ROW ===== */
    .bank-row {
      margin-top: 0.18in;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      position: relative;
      z-index: 2;
    }

    .bank-logo-block {
      display: flex;
      flex-direction: column;
      gap: 0.05in;
    }

    .bank-logo {
      width: 2.4in;
      height: 0.65in;
      border: 1px solid #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      text-align: center;
      overflow: hidden;
      position: relative;
    }

    .bank-logo img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: none;
    }

    .bank-logo.has-logo #bank-logo-text {
      display: none;
    }

    /* ===== MEMO + SIGNATURE AREA ===== */
    .bottom-row {
      margin-top: 0.22in;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      font-size: 10px;
      position: relative;
      z-index: 2;
    }

    .memo-container {
      display: flex;
      align-items: baseline;
      gap: 0.10in;
      margin-bottom: 0.05in;
    }

    .memo-line {
      border-bottom: 1px solid #000;
      width: 2.6in;
      position: relative;
      height: 0.18in;
    }

    #field-memo {
      position: absolute;
      left: 0;
      bottom: 0.02in;
      font-size: 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      right: 0;
    }

    .signature-container {
      margin-right: 0.50in;
    }

    .signature-line {
      border-bottom: 1px solid #000;
      margin-top: 0.10in;
      width: 2.5in;
    }

    /* ===== MICR LINE (E-13B) ===== */
    .micr-line {
      position: absolute;
      bottom: 0.12in;
      left: 0.30in;
      right: 0.30in;
      font-family: 'MICR', monospace;
      font-size: 12px;
      letter-spacing: 0.08em;
      text-align: left;
      z-index: 2;
    }

    /* ===== PRINT BUTTON ===== */
    .print-button {
      position: absolute;
      bottom: 0.2in;
      right: 0.25in;
      padding: 0.08in 0.25in;
      font-size: 11px;
      border-radius: 4px;
      border: 1px solid #444;
      background: #eee;
      cursor: pointer;
      z-index: 10;
    }

    .print-button:hover {
      background: #ddd;
    }

    @media print {
      .print-button {
        display: none;
      }
    }
  </style>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
</head>
<body>
  <div class="page">
    <!-- PRINT BUTTON -->
    <button class="print-button" onclick="window.print()">Print</button>

    <!-- ================= CHECK AREA ================= -->
    <div class="check-area">

      <!-- VOID WATERMARK -->
      <div class="void-watermark" id="void-watermark">VOID</div>

      <!-- TOP HEADER -->
      <div class="top-row">
        <div class="account-block">
          <div class="account-name" id="field-accountname">{{AccountHolderName}}</div>
          <div id="field-addr1">{{StreetAddressLine1}}</div>
          <div id="field-addr2">{{StreetAddressLine2}}</div>
          <div id="field-citystatezip">{{City}}, {{State}} {{Zip}}</div>
        </div>

        <div class="date-block">
          Date: <span class="date-line" id="field-checkdate">{{CheckDate}}</span>
        </div>

        <div class="check-number-block" id="field-checknum">
          {{CheckNumber}}
        </div>
      </div>

      <!-- PAYEE ROW -->
      <div class="payee-row">
        <div class="payee-label">Pay to the<br>Order of</div>
        <div class="payee-line" id="field-payto">{{PayTo}}</div>
        <div class="amount-block-inline">
          $ <div class="amount-box" id="field-amount">{{Amount}}</div>
        </div>
      </div>

      <!-- AMOUNT IN WORDS -->
      <div class="amount-words-row">
        <div>***</div>
        <div class="amount-words-line">
          <span class="amount-words-text" id="field-amountwords">{{AmountInWords}}</span>
        </div>
        <div>Dollars</div>
      </div>

      <!-- BANK LOGO -->
      <div class="bank-row">
        <div class="bank-logo-block">
          <div class="bank-logo" id="field-banklogo">
            <img id="bank-logo-img" alt="Bank logo" />
            <span id="bank-logo-text">{{BankName}} LOGO</span>
          </div>
        </div>
      </div>

      <!-- MEMO + SIGNATURE -->
      <div class="bottom-row">
        <div class="memo-container">
          <div>Memo:</div>
          <div class="memo-line">
            <span id="field-memo"></span>
          </div>
        </div>

        <div class="signature-container">
          <div class="signature-line"></div>
        </div>
      </div>

      <!-- MICR -->
      <div class="micr-line" id="field-micr">
        {{MicrLine}}
      </div>

    </div>
  </div>

  <script>
    grist.ready();

    function setText(id, value) {
      var el = document.getElementById(id);
      if (!el) return;
      if (value == null || value === undefined) {
        el.textContent = '';
      } else {
        el.textContent = String(value);
      }
    }

    function formatAmount(value) {
      if (value == null || value === '') return '';
      var num = Number(value);
      if (isNaN(num)) return String(value);
      return num.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
    }

    // --- Number-to-words helpers for amount-in-words ---
    function numberToWordsUnder1000(n) {
      var ones = [
        '', 'One', 'Two', 'Three', 'Four', 'Five', 'Six',
        'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve',
        'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen',
        'Seventeen', 'Eighteen', 'Nineteen'
      ];
      var tens = [
        '', '', 'Twenty', 'Thirty', 'Forty', 'Fifty',
        'Sixty', 'Seventy', 'Eighty', 'Ninety'
      ];

      var result = '';

      if (n >= 100) {
        result += ones[Math.floor(n / 100)] + ' Hundred';
        n = n % 100;
        if (n > 0) result += ' ';
      }
      if (n >= 20) {
        result += tens[Math.floor(n / 10)];
        n = n % 10;
        if (n > 0) result += '-' + ones[n];
      } else if (n > 0) {
        result += ones[n];
      }

      return result || 'Zero';
    }

    function numberToWordsDollars(n) {
      if (n === 0) return 'Zero';
      if (!Number.isFinite(n) || n < 0) return String(n);

      var parts = [];

      var billions = Math.floor(n / 1000000000);
      if (billions) {
        parts.push(numberToWordsUnder1000(billions) + ' Billion');
        n = n % 1000000000;
      }

      var millions = Math.floor(n / 1000000);
      if (millions) {
        parts.push(numberToWordsUnder1000(millions) + ' Million');
        n = n % 1000000;
      }

      var thousands = Math.floor(n / 1000);
      if (thousands) {
        parts.push(numberToWordsUnder1000(thousands) + ' Thousand');
        n = n % 1000;
      }

      if (n) {
        parts.push(numberToWordsUnder1000(n));
      }

      return parts.join(' ');
    }

    function formatAmountInWords(value) {
      if (value == null || value === '') return '';
      var num = Number(value);
      if (isNaN(num)) return String(value);

      var centsTotal = Math.round(num * 100);
      var dollars   = Math.floor(centsTotal / 100);
      var cents     = centsTotal % 100;

      var words = numberToWordsDollars(dollars);
      var centsStr = String(cents).padStart(2, '0');

      return words + ' & ' + centsStr + '/100 ----------------';
    }

    // --- Bank table cache (by Account_Name text) ---
    var bankByAccountName = null;

    async function ensureBankCache() {
      if (bankByAccountName) return;

      bankByAccountName = {};

      try {
        var table = await grist.docApi.fetchTable('CheckAccountData');
        var cols = table;
        var ids = cols.id || cols.ID || cols.Id;
        if (!ids) return;

        for (var i = 0; i < ids.length; i++) {
          var row = {
            id: ids[i],
            Account_Name: cols.Account_Name ? cols.Account_Name[i] : null,
            Account_Holder_Name: cols.Account_Holder_Name ? cols.Account_Holder_Name[i] : null,
            Street_Address_Line_1: cols.Street_Address_Line_1 ? cols.Street_Address_Line_1[i] : null,
            Street_Address_Line_2: cols.Street_Address_Line_2 ? cols.Street_Address_Line_2[i] : null,
            City: cols.City ? cols.City[i] : null,
            State: cols.State ? cols.State[i] : null,
            Zip: cols.Zip ? cols.Zip[i] : null,
            Bank_Name: cols.Bank_Name ? cols.Bank_Name[i] : null,
            Bank_Logo: cols.Bank_Logo ? cols.Bank_Logo[i] : null,
            Routing_Number: cols.Routing_Number ? cols.Routing_Number[i] : null,
            Account_Number: cols.Account_Number ? cols.Account_Number[i] : null
          };

          var acct = row.Account_Name;
          if (acct) {
            bankByAccountName[acct.toString().trim()] = row;
          }
        }
      } catch (e) {
        console.error('Error loading CheckAccountData table:', e);
        bankByAccountName = {};
      }
    }

    function buildCityStateZip(row) {
      var city = row.City || '';
      var state = row.State || '';
      var zip = row.Zip || '';
      var parts = [];
      if (city) parts.push(city);
      if (state) parts.push(state);
      var line = parts.join(', ');
      if (zip) line = line ? (line + ' ' + zip) : zip;
      return line;
    }

    function resolveBankRow(bankCell) {
      if (!bankCell || !bankByAccountName) return null;
      var key = bankCell.toString().trim();
      return bankByAccountName[key] || null;
    }

    async function updateFromRecord(record) {
      if (!record) return;
      console.log('Selected row:', record);

      // Core check fields
      setText('field-payto', record.Pay_To);
      setText('field-amount', formatAmount(record.Amount));
      setText('field-checknum', record.Check_Number);
      setText('field-checkdate', record.Check_Date);
      setText('field-memo', record.Memo);
      setText('field-amountwords', formatAmountInWords(record.Amount));

      // VOID watermark
      var status = (record.Status || '').toString().toLowerCase();
      var voidEl = document.getElementById('void-watermark');
      if (voidEl) {
        voidEl.style.display = status.startsWith('void') ? 'block' : 'none';
      }

      // Clear header + MICR before filling
      setText('field-accountname', '');
      setText('field-addr1', '');
      var addr2El = document.getElementById('field-addr2');
      if (addr2El) {
        addr2El.style.display = 'none';
        addr2El.textContent = '';
      }
      setText('field-citystatezip', '');
      setText('field-micr', '');

      var logoWrapper = document.getElementById('field-banklogo');
      var logoImg = document.getElementById('bank-logo-img');
      var logoText = document.getElementById('bank-logo-text');
      if (logoWrapper && logoImg && logoText) {
        logoWrapper.classList.remove('has-logo');
        logoImg.src = '';
        logoImg.style.display = 'none';
        logoText.textContent = '{{BankName}} LOGO';
      }

      // No bank? stop here
      if (record.Bank == null || record.Bank === '') {
        return;
      }

      // Load bank table and resolve row by Account_Name
      await ensureBankCache();
      var bankRow = resolveBankRow(record.Bank);
      console.log('Resolved bankRow:', bankRow);

      if (!bankRow) {
        return;
      }

      // Account / address
      var acctName = bankRow.Account_Holder_Name || bankRow.Account_Name || '';
      setText('field-accountname', acctName);
      setText('field-addr1', bankRow.Street_Address_Line_1 || '');

      if (addr2El) {
        var addr2Val = bankRow.Street_Address_Line_2 || '';
        if (addr2Val) {
          addr2El.style.display = '';
          addr2El.textContent = addr2Val;
        } else {
          addr2El.style.display = 'none';
          addr2El.textContent = '';
        }
      }

      setText('field-citystatezip', buildCityStateZip(bankRow));

      // Bank name text / logo placeholder
      var bankName = bankRow.Bank_Name || '';
      if (logoText) {
        logoText.textContent = bankName ? (bankName + ' LOGO') : 'BANK LOGO';
      }

      // Bank logo from attachment (handles array or single id)
      if (logoWrapper && logoImg) {
        var logoCell = bankRow.Bank_Logo;
        var logoIds = [];

        if (Array.isArray(logoCell)) {
          logoIds = logoCell;
        } else if (logoCell != null && logoCell !== '') {
          logoIds = [logoCell];
        }

        if (logoIds.length > 0) {
          try {
            var url = await grist.docApi.getAttachmentUrl(logoIds[0]);
            logoImg.src = url;
            logoImg.style.display = 'block';
            logoWrapper.classList.add('has-logo');
          } catch (e) {
            console.error('Error loading bank logo attachment', e, 'logoCell:', logoCell);
            logoImg.src = '';
            logoImg.style.display = 'none';
            logoWrapper.classList.remove('has-logo');
          }
        } else {
          logoImg.src = '';
          logoImg.style.display = 'none';
          logoWrapper.classList.remove('has-logo');
        }
      }

      // MICR line
      var micr = record.MicrLine || record.Micr_Line;
      if (!micr) {
        var routing = bankRow.Routing_Number;
        var account = bankRow.Account_Number;
        var chk = record.Check_Number;
        if (routing && account && chk != null && chk !== '') {
          micr = 'A' + routing + 'A ' + String(chk) + 'C ' + account + 'C';
        }
      }
      setText('field-micr', micr || '');
    }

    grist.onRecord(function(record) {
      updateFromRecord(record);
    });
  </script>
</body>
</html>
